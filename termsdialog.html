<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato&family=Roboto&display=swap" rel="stylesheet">
    <style>

      html {
        font-family: "Roboto";
      }

      .term {
        display: block;
        position: relative;
        cursor: pointer;
        padding-left: 35px;
        margin-bottom: 15px;
      }

      .term-checkbox {
        display: inline-block;
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
      }

      .checkmark {
        position: absolute;
        top: 0;
        left: 0;
        height: 20px;
        width: 20px;
        border-radius: 2px;
        background-color: #eee;
      }

      .checkmark:after {
        content: "";
        position: absolute;
        display: none;
      }

      .term input:checked ~ .checkmark:after {
        display: block;
      }

      .term .checkmark:after {
        position: absolute;
        content: "";
        top: 50%;
        left: 3px;
        transform: scaleX(-1) rotate(135deg);
        height: 10px;
        width: 5px;
        border-top: 3px solid #5cb85c;
        border-right: 3px solid #5cb85c;
        transform-origin: left top;
        animation: checkmark 0.8s ease;
      }

      @keyframes checkmark {
        0%{
          height: 0;
          width: 0;
          opacity: 1;
        }
        20%{
          height: 0;
          width: 5px;
          opacity: 1;
        }
        40%{
          height: 10px;
         width: 5px;
         opacity: 1;
        }
       100%{
         height: 10px;
         width: 5px;
          opacity: 1;
        }
      }

      .term-text-input {
        border-style: hidden;
      }

      .term-text-input:focus {
        outline: none;
      }

      .term-text-input-container {
        display: inline-block;
        margin: 0;
      }

      .term-text-input-container:after {
        display: block;
        content: "";
        border-bottom: solid 1px #808080;
        transform: scaleX(0);
        transition: transform 200ms ease-in-out;
      }

      .term-text-input-container:hover:after {
        transform: scaleX(1);
      }

      .addition-button {
        border: none;
        background-color: white;
        cursor: pointer;
        color: #4f7942;
        font-style: italic;
      }

    </style>
  </head>
  <body onload="getSavedTermsList()">
    <div class="terms-list-container">
      <div id="terms-drawer" class="terms-drawer">
        <label class="term">
          <input class="term-checkbox" type="checkbox" name="term1" onchange="changeCheckboxStatus(this.name, this.checked, this.value)">
          <div class="term-text-input-container">
            <input class="term-text-input" id="term1" type="text" name="term-text-input" onchange="updateTermCheckbox(this.id, this.value)">
          </div>
          <span class="checkmark"></span>
        </label>
      </div>
      <div class="addition-container">
        <input class="addition-button" type="button" onclick="addNewTermElement()" value="add a new term...">
      </div>
    </div>
    <script>

      let termsList = new Object();
      let newTermIndex = 0;

      // Gets all terms checked off in terms container
      function getCheckedTerms() {
        var terms = document.getElementsByName("term-text-input");
        var used = [];
        for (var i=0; i<terms.length; i++) {
          if (terms[i].value != "") {
            used.push(terms[i].value);
          }
        }
        return used;
      }

      // Used by both the document and deserializing data
      function addNewTermElement(id = null, term = null, state = null) {
        // Create master term element
        var termNode = document.createElement("label");
        termNode.className = "term";

        // Create checkbox input element
        var termCheckboxInputNode = document.createElement("input");
        termCheckboxInputNode.className = "term-checkbox";
        termCheckboxInputNode.type = "checkbox";
        if (term != null) {
          termCheckboxInputNode.setAttribute("value", term);
        }
        if (state != null) {
          termCheckboxInputNode.checked = state;
        }
        termCheckboxInputNode.setAttribute("onchange", "changeCheckboxStatus(this.name, this.checked, this.value)");
        termNode.appendChild(termCheckboxInputNode);

        // Create text input container element
        var termTextInputContainerNode = document.createElement("div");
        termTextInputContainerNode.className = "term-text-input-container";
        termNode.appendChild(termTextInputContainerNode);

        // Create text input element
        var termTextInputNode = document.createElement("input");
        termTextInputNode.className = "term-text-input";
        // Used by loading function
        if (id != null) {
          termTextInputNode.id = id
        }
        else {
          termTextInputNode.id = "term" + newTermIndex;
        }
        termTextInputNode.type = "text";
        termTextInputNode.setAttribute("name", "term-text-input");
        termTextInputNode.setAttribute("onchange", "updateTermCheckbox(this.id, this.value)")
        // Again, used by loading function
        if (term != null) {
          termTextInputNode.value = term;
        }
        else {
          termTextInputNode.value = "New term"
        }
        termTextInputContainerNode.appendChild(termTextInputNode);

        // Create checkmark element
        var checkmarkNode = document.createElement("span");
        checkmarkNode.className = "checkmark";
        termNode.appendChild(checkmarkNode);

        // Append master to document
        document.getElementById("terms-drawer").appendChild(termNode);
        newTermIndex++;
      }

      // Update term checkbox node value to term text input node value
      function updateTermCheckbox(termId, newValue) {
        document.getElementsByName("termId")
          .setAttribute("value", newValue);
        updateTermsList(termId, newValue);
        console.log("changed " + termId + " checkbox value to " + newValue);
      }

      // Update checkbox status with server when changed
      function changeCheckboxStatus(termId, newState, newValue) {
        updateTermsList(termId, newValue, newState);
      }

      // Update terms list on server side
      function updateTermsList(termId, newTerm, newState = null) {
        var temp = termsList[termId];
        var newValue = [];
        // Check if there's already an existing state for the term
        if (temp != null) {
          newValue = [temp[0], newTerm];
        }
        else {
          newValue = [newState, newTerm];
        }
        termsList[termId] = newValue;
        google.script.run.onTermsListChanged(termsList);
        console.log(termsList[termId]);
      }

      function createTermsListFromSavedData(termsList) {
        console.log("data found, run deserialize");
        console.log("deserialized " + Object.keys(termsList).length + " terms")
        for (const [key, value] of Object.entries(termsList)) {
          addNewTermElement(key, value[1], value[0]);
        }
      }

      function getSavedTermsList() {
        console.log("get saved terms");
        google.script.run.withSuccessHandler(createTermsListFromSavedData).getSavedTermsList();
      }

    </script>
  </body>
</html>
